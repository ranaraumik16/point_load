{"version":3,"sources":["../../../src/lib/parse-las.js"],"names":["getMeshBoundingBox","LASFile","parseLAS","arraybuffer","options","pointIndex","positions","colors","intensities","classifications","originalHeader","result","onProgress","skip","las","parseLASChunked","decoder","header","total","totalToRead","Float32Array","pointsFormatId","Uint8Array","Uint16Array","Object","assign","loaderData","mode","attributes","POSITION","value","size","intensity","classification","COLOR_0","batchSize","pointsCount","scale","scaleX","scaleY","scaleZ","offset","offsetX","offsetY","offsetZ","i","position","color","getPoint","vertexCount","totalRead","progress","boundingBox","rawData","onParseData","dataHandler","open","getHeader","Unpacker","getUnpacker","Math","ceil","max","chunk","readData","count","versionAsString","isCompressed","unpacker","buffer","hasMoreData","e","close"],"mappings":"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","sourcesContent":["import {getMeshBoundingBox} from '@loaders.gl/loader-utils';\n// ported and es6-ified from https://github.com/verma/plasio/\nimport {LASFile} from './laslaz-decoder';\n\n/* eslint-disable max-statements */\nexport default function parseLAS(arraybuffer, options = {}) {\n  let pointIndex = 0;\n\n  let positions;\n  let colors;\n  let intensities;\n  let classifications;\n  let originalHeader;\n\n  const result = {};\n  const {onProgress} = options;\n  const {skip} = options.las || {};\n\n  parseLASChunked(arraybuffer, skip, (decoder, header) => {\n    if (!originalHeader) {\n      originalHeader = header;\n      const total = header.totalToRead;\n\n      positions = new Float32Array(total * 3);\n      // laslaz-decoder.js `pointFormatReaders`\n      colors = header.pointsFormatId >= 2 ? new Uint8Array(total * 4) : null;\n      intensities = new Uint16Array(total);\n      classifications = new Uint8Array(total);\n\n      Object.assign(result, {\n        loaderData: {header},\n        mode: 0, // GL.POINTS\n        attributes: {\n          POSITION: {value: positions, size: 3},\n          // non-gltf attributes, use non-capitalized names for now\n          intensity: {value: intensities, size: 1},\n          classification: {value: classifications, size: 1}\n        }\n      });\n\n      if (colors) {\n        result.attributes.COLOR_0 = {value: colors, size: 4};\n      }\n    }\n\n    const batchSize = decoder.pointsCount;\n    const {\n      scale: [scaleX, scaleY, scaleZ],\n      offset: [offsetX, offsetY, offsetZ]\n    } = header;\n\n    for (let i = 0; i < batchSize; i++) {\n      const {position, color, intensity, classification} = decoder.getPoint(i);\n\n      positions[pointIndex * 3] = position[0] * scaleX + offsetX;\n      positions[pointIndex * 3 + 1] = position[1] * scaleY + offsetY;\n      positions[pointIndex * 3 + 2] = position[2] * scaleZ + offsetZ;\n\n      if (color) {\n        colors[pointIndex * 4] = color[0];\n        colors[pointIndex * 4 + 1] = color[1];\n        colors[pointIndex * 4 + 2] = color[2];\n        colors[pointIndex * 4 + 3] = 255;\n      }\n\n      intensities[pointIndex] = intensity;\n      classifications[pointIndex] = classification;\n\n      pointIndex++;\n    }\n\n    if (onProgress) {\n      onProgress(\n        Object.assign(\n          {\n            header: {\n              vertexCount: header.totalRead\n            },\n            progress: header.totalRead / header.totalToRead\n          },\n          result\n        )\n      );\n    }\n  });\n\n  result.header = {\n    // @ts-ignore Possibly undefined\n    vertexCount: originalHeader.totalToRead,\n    boundingBox: getMeshBoundingBox(result.attributes)\n  };\n  return result;\n}\n/* eslint-enable max-statements */\n\n/**\n * parse laz data\n * @return {*} parsed point cloud\n */\nexport function parseLASChunked(rawData, skip, onParseData) {\n  const dataHandler = new LASFile(rawData);\n\n  try {\n    // open data\n    dataHandler.open();\n\n    const header = dataHandler.getHeader();\n    // start loading\n    const Unpacker = dataHandler.getUnpacker();\n\n    const totalToRead = Math.ceil(header.pointsCount / Math.max(1, skip));\n    header.totalToRead = totalToRead;\n    let totalRead = 0;\n\n    /* eslint-disable no-constant-condition */\n    while (true) {\n      const chunk = dataHandler.readData(1000 * 100, 0, skip);\n\n      totalRead += chunk.count;\n\n      header.totalRead = totalRead;\n      header.versionAsString = chunk.versionAsString;\n      header.isCompressed = chunk.isCompressed;\n\n      const unpacker = new Unpacker(chunk.buffer, chunk.count, header);\n\n      // surface unpacker and progress via call back\n      // use unpacker.pointsCount and unpacker.getPoint(i) to handle data in app\n      onParseData(unpacker, header);\n\n      if (!chunk.hasMoreData || totalRead >= totalToRead) {\n        break;\n      }\n    }\n  } catch (e) {\n    throw e;\n  } finally {\n    dataHandler.close();\n  }\n}\n"],"file":"parse-las.js"}